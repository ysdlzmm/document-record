# Vue æ ¸å¿ƒæ¦‚å¿µ

## ä¸€ã€Vue 3 æ–°ç‰¹æ€§

### 1.1 Composition APIï¼ˆç»„åˆå¼ APIï¼‰

**Options API vs Composition API**

```javascript
// Options APIï¼ˆVue 2ï¼‰
export default {
  data() {
    return {
      count: 0,
      user: null
    };
  },
  computed: {
    doubleCount() {
      return this.count * 2;
    }
  },
  methods: {
    increment() {
      this.count++;
    }
  },
  mounted() {
    console.log('ç»„ä»¶å·²æŒ‚è½½');
  }
}

// Composition APIï¼ˆVue 3ï¼‰
import { ref, computed, onMounted } from 'vue';

export default {
  setup() {
    // å“åº”å¼çŠ¶æ€
    const count = ref(0);
    const user = ref(null);

    // è®¡ç®—å±æ€§
    const doubleCount = computed(() => count.value * 2);

    // æ–¹æ³•
    const increment = () => {
      count.value++;
    };

    // ç”Ÿå‘½å‘¨æœŸé’©å­
    onMounted(() => {
      console.log('ç»„ä»¶å·²æŒ‚è½½');
    });

    // è¿”å›ç»™æ¨¡æ¿
    return {
      count,
      user,
      doubleCount,
      increment
    };
  }
}

// <script setup> è¯­æ³•ç³–ï¼ˆæ¨èï¼‰
<script setup>
import { ref, computed, onMounted } from 'vue';

const count = ref(0);
const doubleCount = computed(() => count.value * 2);

const increment = () => {
  count.value++;
};

onMounted(() => {
  console.log('ç»„ä»¶å·²æŒ‚è½½');
});
</script>

<template>
  <div>
    <p>Count: {{ count }}</p>
    <p>Double: {{ doubleCount }}</p>
    <button @click="increment">å¢åŠ </button>
  </div>
</template>
```

### 1.2 å“åº”å¼åŸç†

```javascript
import { ref, reactive, toRefs, readonly } from 'vue';

// ref - åŸºæœ¬ç±»å‹å“åº”å¼
const count = ref(0);
count.value++; // éœ€è¦ .value

// reactive - å¯¹è±¡å“åº”å¼
const state = reactive({
  count: 0,
  user: {
    name: 'å¼ ä¸‰'
  }
});
state.count++; // ä¸éœ€è¦ .value

// toRefs - è§£æ„ reactive å¯¹è±¡
const { count, user } = toRefs(state);
count.value++; // éœ€è¦å› .value

// readonly - åªè¯»ä»£ç†
const readonlyState = readonly(state);
// readonlyState.count = 1; // è­¦å‘Šï¼šä¸èƒ½ä¿®æ”¹

// computed - è®¡ç®—å±æ€§
const doubleCount = computed(() => count.value * 2);

// writable computed
const fullName = computed({
  get: () => `${firstName.value} ${lastName.value}`,
  set: (value) => {
    [firstName.value, lastName.value] = value.split(' ');
  }
});
```

---

## äºŒã€æ ¸å¿ƒæ¦‚å¿µæ·±å…¥

### 2.1 ç”Ÿå‘½å‘¨æœŸ

```javascript
<script setup>
import {
  onBeforeMount,
  onMounted,
  onBeforeUpdate,
  onUpdated,
  onBeforeUnmount,
  onUnmounted,
  onErrorCaptured
} from 'vue';

// æŒ‚è½½å‰
onBeforeMount(() => {
  console.log('DOM æŒ‚è½½å‰');
});

// æŒ‚è½½å®Œæˆ
onMounted(() => {
  console.log('DOM å·²æŒ‚è½½');
  // å¯ä»¥è®¿é—® DOM
});

// æ›´æ–°å‰
onBeforeUpdate(() => {
  console.log('æ•°æ®æ›´æ–°å‰');
});

// æ›´æ–°å®Œæˆ
onUpdated(() => {
  console.log('DOM å·²æ›´æ–°');
});

// å¸è½½å‰
onBeforeUnmount(() => {
  console.log('ç»„ä»¶å¸è½½å‰');
  // æ¸…ç†å®šæ—¶å™¨ã€äº‹ä»¶ç›‘å¬å™¨
});

// å¸è½½å®Œæˆ
onUnmounted(() => {
  console.log('ç»„ä»¶å·²å¸è½½');
});

// é”™è¯¯æ•è·
onErrorCaptured((err, instance, info) => {
  console.error('æ•è·é”™è¯¯:', err);
  return false; // é˜»æ­¢é”™è¯¯ç»§ç»­ä¼ æ’­
});
</script>
```

### 2.2 ç»„ä»¶é€šä¿¡

```javascript
// çˆ¶ç»„ä»¶
<script setup>
import { ref } from 'vue';
import Child from './Child.vue';

const message = ref('æ¥è‡ªçˆ¶ç»„ä»¶çš„æ¶ˆæ¯');
const childMessage = ref('');

const receiveFromChild = (msg) => {
  childMessage.value = msg;
};
</script>

<template>
  <div>
    <Child
      :message="message"
      @update="receiveFromChild"
    />
    <p>å­ç»„ä»¶è¯´ï¼š{{ childMessage }}</p>
  </div>
</template>

// å­ç»„ä»¶ Child.vue
<script setup>
import { defineProps, defineEmits } from 'vue';

// å®šä¹‰ props
const props = defineProps({
  message: {
    type: String,
    required: true
  }
});

// å®šä¹‰ emits
const emit = defineEmits(['update']);

const sendToParent = () => {
  emit('update', 'æ¥è‡ªå­ç»„ä»¶çš„æ¶ˆæ¯');
};
</script>

<template>
  <div>
    <p>{{ message }}</p>
    <button @click="sendToParent">å‘é€æ¶ˆæ¯</button>
  </div>
</template>
```

### 2.3 Provide / Inject

```javascript
// ç¥–å…ˆç»„ä»¶
<script setup>
import { provide, ref, readonly } from 'vue';

const theme = ref('light');
const user = ref({ name: 'å¼ ä¸‰' });

// æä¾›å“åº”å¼æ•°æ®
provide('theme', readonly(theme)); // åªè¯»ï¼Œé˜²æ­¢å­ç»„ä»¶ä¿®æ”¹
provide('user', readonly(user));

// æä¾›æ›´æ–°æ–¹æ³•
provide('setTheme', (newTheme) => {
  theme.value = newTheme;
});
</script>

// åä»£ç»„ä»¶
<script setup>
import { inject } from 'vue';

// æ³¨å…¥æ•°æ®
const theme = inject('theme');
const user = inject('user', { name: 'é»˜è®¤ç”¨æˆ·' }); // é»˜è®¤å€¼

// æ³¨å…¥æ–¹æ³•
const setTheme = inject('setTheme');
</script>

<template>
  <div>
    <p>ä¸»é¢˜: {{ theme }}</p>
    <button @click="setTheme('dark')">åˆ‡æ¢ä¸»é¢˜</button>
  </div>
</template>
```

---

## ä¸‰ã€Composition API å®æˆ˜

### 3.1 è‡ªå®šä¹‰ç»„åˆå¼å‡½æ•°ï¼ˆç±»ä¼¼ React Hooksï¼‰

```javascript
// composables/useMouse.js
import { ref, onMounted, onUnmounted } from 'vue';

export function useMouse() {
  const x = ref(0);
  const y = ref(0);

  const update = (event) => {
    x.value = event.pageX;
    y.value = event.pageY;
  };

  onMounted(() => {
    window.addEventListener('mousemove', update);
  });

  onUnmounted(() => {
    window.removeEventListener('mousemove', update);
  });

  return { x, y };
}

// ä½¿ç”¨
<script setup>
import { useMouse } from './composables/useMouse';

const { x, y } = useMouse();
</script>

<template>
  <div>é¼ æ ‡ä½ç½®ï¼š({{ x }}, {{ y }})</div>
</template>
```

### 3.2 æ•°æ®è·å–

```javascript
// composables/useFetch.js
import { ref, onMounted } from 'vue';

export function useFetch(url) {
  const data = ref(null);
  const error = ref(null);
  const loading = ref(false);

  const fetchData = async () => {
    loading.value = true;
    error.value = null;

    try {
      const response = await fetch(url);
      data.value = await response.json();
    } catch (err) {
      error.value = err;
    } finally {
      loading.value = false;
    }
  };

  onMounted(() => {
    fetchData();
  });

  return {
    data,
    error,
    loading,
    refetch: fetchData
  };
}

// ä½¿ç”¨
<script setup>
import { useFetch } from './composables/useFetch';

const { data, loading, error } = useFetch('https://api.example.com/data');
</script>

<template>
  <div v-if="loading">åŠ è½½ä¸­...</div>
  <div v-else-if="error">é”™è¯¯: {{ error.message }}</div>
  <div v-else>{{ data }}</div>
</template>
```

### 3.3 è¡¨å•å¤„ç†

```javascript
// composables/useForm.js
import { reactive, computed } from 'vue';

export function useForm(initialValues, validationRules) {
  const form = reactive({ ...initialValues });
  const errors = reactive({});
  const touched = reactive({});

  const validate = () => {
    Object.keys(validationRules).forEach(field => {
      const rule = validationRules[field];
      const value = form[field];

      if (rule.required && !value) {
        errors[field] = 'æ­¤é¡¹å¿…å¡«';
      } else if (rule.pattern && !rule.pattern.test(value)) {
        errors[field] = rule.message || 'æ ¼å¼ä¸æ­£ç¡®';
      } else {
        errors[field] = '';
      }
    });
  };

  const handleInput = (field, value) => {
    form[field] = value;
    touched[field] = true;
    validate();
  };

  const isValid = computed(() => {
    return Object.values(errors).every(error => !error);
  });

  const reset = () => {
    Object.assign(form, initialValues);
    Object.keys(errors).forEach(key => {
      errors[key] = '';
    });
  };

  return {
    form,
    errors,
    touched,
    isValid,
    handleInput,
    reset
  };
}

// ä½¿ç”¨
<script setup>
import { useForm } from './composables/useForm';

const { form, errors, isValid, handleInput } = useForm(
  {
    username: '',
    password: ''
  },
  {
    username: {
      required: true,
      pattern: /^[a-zA-Z0-9]{6,12}$/,
      message: '6-12 ä½å­—æ¯æˆ–æ•°å­—'
    },
    password: {
      required: true
    }
  }
);

const handleSubmit = () => {
  if (isValid.value) {
    console.log('æäº¤è¡¨å•:', form);
  }
};
</script>

<template>
  <form @submit.prevent="handleSubmit">
    <input
      v-model="form.username"
      @input="handleInput('username', $event.target.value)"
    />
    <span v-if="errors.username">{{ errors.username }}</span>

    <input
      type="password"
      v-model="form.password"
      @input="handleInput('password', $event.target.value)"
    />
    <span v-if="errors.password">{{ errors.password }}</span>

    <button :disabled="!isValid">æäº¤</button>
  </form>
</template>
```

---

## å››ã€æŒ‡ä»¤ä¸æ¨¡æ¿è¯­æ³•

### 4.1 å¸¸ç”¨æŒ‡ä»¤

```vue
<template>
  <!-- v-bind - å±æ€§ç»‘å®šï¼ˆç®€å†™ :ï¼‰ -->
  <img :src="imageSrc" :alt="imageAlt" />
  <div :class="{ active: isActive }" />
  <div :style="{ color: textColor, fontSize: '16px' }" />

  <!-- v-on - äº‹ä»¶ç›‘å¬ï¼ˆç®€å†™ @ï¼‰ -->
  <button @click="handleClick">ç‚¹å‡»</button>
  <input @keyup.enter="handleSubmit" />

  <!-- v-model - åŒå‘ç»‘å®š -->
  <input v-model="text" />
  <textarea v-model="message" />
  <select v-model="selected">
    <option value="a">A</option>
    <option value="b">B</option>
  </select>

  <!-- v-if / v-else-if / v-else -->
  <div v-if="type === 'A'">A</div>
  <div v-else-if="type === 'B'">B</div>
  <div v-else>Other</div>

  <!-- v-show - CSS display åˆ‡æ¢ -->
  <div v-show="isVisible">å¯è§</div>

  <!-- v-for - åˆ—è¡¨æ¸²æŸ“ -->
  <li v-for="item in items" :key="item.id">
    {{ item.name }}
  </li>

  <!-- v-slot - æ’æ§½ï¼ˆç®€å†™ #ï¼‰ -->
  <MyComponent>
    <template #header>å¤´éƒ¨</template>
    <template #default>å†…å®¹</template>
    <template #footer>åº•éƒ¨</template>
  </MyComponent>

  <!-- v-memo - æ€§èƒ½ä¼˜åŒ–ï¼ˆVue 3.2+ï¼‰ -->
  <div v-memo="[value]">
    <!-- ä»…åœ¨ value å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“ -->
    <p>{{ value }}</p>
  </div>
</template>
```

### 4.2 è‡ªå®šä¹‰æŒ‡ä»¤

```javascript
// main.js
import { createApp } from 'vue';

const app = createApp(App);

// å…¨å±€æŒ‡ä»¤
app.directive('focus', {
  mounted(el) {
    el.focus();
  }
});

app.directive('lazy', {
  mounted(el, binding) {
    // æ‡’åŠ è½½å›¾ç‰‡
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          el.src = binding.value;
          observer.unobserve(el);
        }
      });
    });
    observer.observe(el);
  }
});

// å±€éƒ¨æŒ‡ä»¤
<script setup>
const vHighlight = {
  mounted(el, binding) {
    el.style.backgroundColor = binding.value;
  }
};
</script>

<template>
  <input v-focus />
  <img v-lazy="imageSrc" />
  <div v-highlight="'yellow'">é«˜äº®æ–‡æœ¬</div>
</template>
```

---

## äº”ã€ç»„ä»¶é«˜çº§ç”¨æ³•

### 5.1 æ’æ§½

```vue
<!-- BaseLayout.vue -->
<template>
  <div class="layout">
    <header>
      <slot name="header">
        <h1>é»˜è®¤æ ‡é¢˜</h1>
      </slot>
    </header>

    <main>
      <slot>
        é»˜è®¤å†…å®¹
      </slot>
    </main>

    <footer>
      <slot name="footer" />
    </footer>
  </div>
</template>

<!-- ä½¿ç”¨ -->
<BaseLayout>
  <template #header>
    <h1>è‡ªå®šä¹‰æ ‡é¢˜</h1>
  </template>

  <p>ä¸»è¦å†…å®¹</p>

  <template #footer>
    <p>é¡µè„š</p>
  </template>
</BaseLayout>

<!-- ä½œç”¨åŸŸæ’æ§½ -->
<UserList>
  <template #default="{ user }">
    <span>{{ user.name }} - {{ user.email }}</span>
  </template>
</UserList>
```

### 5.2 åŠ¨æ€ç»„ä»¶

```vue
<script setup>
import { ref, defineAsyncComponent } from 'vue';

import Home from './Home.vue';
import About from './About.vue';
import Contact from './Contact.vue';

// åŒæ­¥åŠ¨æ€ç»„ä»¶
const currentTab = ref('home');
const tabs = {
  home: Home,
  about: About,
  contact: Contact
};

// å¼‚æ­¥ç»„ä»¶ï¼ˆå¸¦åŠ è½½çŠ¶æ€ï¼‰
const AsyncHome = defineAsyncComponent({
  loader: () => import('./Home.vue'),
  loadingComponent: LoadingSpinner,
  errorComponent: ErrorComponent,
  delay: 200,
  timeout: 3000
});
</script>

<template>
  <!-- åŠ¨æ€ç»„ä»¶ -->
  <component :is="tabs[currentTab]" />

  <!-- ä½¿ç”¨ keep-alive ç¼“å­˜ç»„ä»¶ -->
  <keep-alive>
    <component :is="tabs[currentTab]" />
  </keep-alive>

  <!-- æ ‡ç­¾åˆ‡æ¢ -->
  <button @click="currentTab = 'home'">é¦–é¡µ</button>
  <button @click="currentTab = 'about'">å…³äº</button>
</template>
```

### 5.3 Teleportï¼ˆä¼ é€é—¨ï¼‰

```vue
<script setup>
import { ref } from 'vue';

const showModal = ref(false);
</script>

<template>
  <div>
    <button @click="showModal = true">æ‰“å¼€æ¨¡æ€æ¡†</button>

    <!-- ä¼ é€åˆ° body -->
    <Teleport to="body">
      <div v-if="showModal" class="modal">
        <div class="modal-content">
          <p>æ¨¡æ€æ¡†å†…å®¹</p>
          <button @click="showModal = false">å…³é—­</button>
        </div>
      </div>
    </Teleport>
  </div>
</template>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
}
</style>
```

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–

### 6.1 è®¡ç®—å±æ€§ç¼“å­˜

```javascript
<script setup>
import { ref, computed } from 'vue';

const list = ref([1, 2, 3, 4, 5]);

// âœ… ä½¿ç”¨ computedï¼ˆæœ‰ç¼“å­˜ï¼‰
const evenNumbers = computed(() => {
  console.log('è®¡ç®—å¶æ•°');
  return list.value.filter(n => n % 2 === 0);
});

// âŒ ä½¿ç”¨æ–¹æ³•ï¼ˆæ¯æ¬¡è°ƒç”¨éƒ½é‡æ–°è®¡ç®—ï¼‰
const getEvenNumbers = () => {
  console.log('è®¡ç®—å¶æ•°');
  return list.value.filter(n => n % 2 === 0);
};
</script>

<template>
  <!-- computed åªåœ¨ list å˜åŒ–æ—¶é‡æ–°è®¡ç®— -->
  <div v-for="n in evenNumbers" :key="n">{{ n }}</div>

  <!-- æ–¹æ³•æ¯æ¬¡æ¸²æŸ“éƒ½è°ƒç”¨ -->
  <div v-for="n in getEvenNumbers()" :key="n">{{ n }}</div>
</template>
```

### 6.2 v-memo ä¼˜åŒ–

```vue
<script setup>
import { ref } from 'vue';

const list = ref([
  { id: 1, name: 'A', value: 100 },
  { id: 2, name: 'B', value: 200 },
  { id: 3, name: 'C', value: 300 }
]);
</script>

<template>
  <!-- ä»…åœ¨ item.value å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“ -->
  <div
    v-for="item in list"
    :key="item.id"
    v-memo="[item.value]"
  >
    {{ item.name }}: {{ item.value }}
  </div>
</template>
```

### 6.3 è™šæ‹Ÿæ»šåŠ¨

```vue
<script setup>
import { ref } from 'vue';

const largeList = ref(Array.from({ length: 10000 }, (_, i) => ({
  id: i,
  text: `Item ${i}`
})));

// ä½¿ç”¨ vue-virtual-scroller åº“
import { RecycleScroller } from 'vue-virtual-scroller';
import 'vue-virtual-scroller/dist/vue-virtual-scroller.css';
</script>

<template>
  <RecycleScroller
    :items="largeList"
    :item-size="50"
    key-field="id"
  >
    <template #default="{ item }">
      <div class="item">{{ item.text }}</div>
    </template>
  </RecycleScroller>
</template>
```

---

## ä¸ƒã€å¸¸è§é—®é¢˜ä¸é¿å‘æŒ‡å—

### âŒ é—®é¢˜ 1ï¼šå“åº”å¼ä¸¢å¤±

```javascript
<script setup>
import { reactive } from 'vue';

// âŒ ç›´æ¥èµ‹å€¼ä¼šä¸¢å¤±å“åº”å¼
const state = reactive({ count: 0 });
state = { count: 1 }; // ä¸¢å¤±å“åº”å¼

// âœ… ä½¿ç”¨ Object.assign
Object.assign(state, { count: 1 });

// âœ… æˆ–ä½¿ç”¨ ref
const state = ref({ count: 0 });
state.value = { count: 1 };
</script>
```

### âŒ é—®é¢˜ 2ï¼šè§£æ„ reactive

```javascript
<script setup>
import { reactive } from 'vue';

const state = reactive({
  count: 0,
  name: 'Vue'
});

// âŒ è§£æ„ä¼šä¸¢å¤±å“åº”å¼
const { count, name } = state;

// âœ… ä½¿ç”¨ toRefs
import { toRefs } from 'vue';
const { count, name } = toRefs(state);

// ç°åœ¨éœ€è¦ .value
count.value++;
</script>
```

### âŒ é—®é¢˜ 3ï¼šæ¨¡æ¿ä¸­å¤šæ¬¡è®¿é—®

```vue
<script setup>
import { computed } from 'vue';

const props = defineProps(['user']);

// âŒ æ¨¡æ¿ä¸­å¤šæ¬¡è®¿é—® fullName æ¯æ¬¡éƒ½é‡æ–°è®¡ç®—
const fullName = () => {
  return `${props.user.firstName} ${props.user.lastName}`;
};

// âœ… ä½¿ç”¨ computedï¼ˆæœ‰ç¼“å­˜ï¼‰
const fullName = computed(() => {
  return `${props.user.firstName} ${props.user.lastName}`;
});
</script>
```

---

## å…«ã€æ€»ç»“ä¸è®°å¿†è¦ç‚¹

### ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€

```
Composition API å¼ºå¤§
setup å‡½æ•°æ˜¯å…¥å£
ref reactive å“åº”å¼
computed è®¡ç®—æœ‰ç¼“å­˜
watch watchEffect ç›‘å¬
ç”Ÿå‘½å‘¨æœŸ on å‰ç¼€
defineProps defineEmits
provide inject ä¼ å€¼
slot æ’æ§½çµæ´»ç”¨
component åŠ¨æ€ç»„ä»¶
Teleport ä¼ é€é—¨
keep-alive ç¼“å­˜çŠ¶æ€
æ€§èƒ½ä¼˜åŒ–è®°å¿ƒä¸Š
```

### ğŸ“š å…³é”®æŠ€æœ¯ç‚¹

1. **Composition API**ï¼šsetupã€refã€reactiveã€computed
2. **ç”Ÿå‘½å‘¨æœŸ**ï¼šonMountedã€onUpdatedã€onUnmounted
3. **ç»„ä»¶é€šä¿¡**ï¼špropsã€emitsã€provide/inject
4. **è‡ªå®šä¹‰ Hooks**ï¼šcomposables å‡½æ•°å¤ç”¨
5. **æŒ‡ä»¤**ï¼šv-modelã€v-ifã€v-forã€v-show
6. **é«˜çº§ç”¨æ³•**ï¼šæ’æ§½ã€åŠ¨æ€ç»„ä»¶ã€Teleport
7. **æ€§èƒ½ä¼˜åŒ–**ï¼šcomputed ç¼“å­˜ã€v-memoã€è™šæ‹Ÿæ»šåŠ¨

---

## ä¹ã€å®æˆ˜ç»ƒä¹ å»ºè®®

1. ç”¨ Composition API é‡æ„ Options API é¡¹ç›®
2. å®ç°è‡ªå®šä¹‰ composablesï¼ˆuseMouseã€useFetchã€useFormï¼‰
3. åˆ›å»ºå¯å¤ç”¨çš„è¡¨å•ç»„ä»¶
4. å®ç°è™šæ‹Ÿæ»šåŠ¨åˆ—è¡¨
5. ç”¨ Teleport å®ç°æ¨¡æ€æ¡†ç»„ä»¶

---

**ä¸‹ä¸€æ­¥å­¦ä¹ **ï¼šğŸ‘‰ [Vue çŠ¶æ€ç®¡ç†](./çŠ¶æ€ç®¡ç†.md)
