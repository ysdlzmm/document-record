# å•å…ƒæµ‹è¯•

## ä¸€ã€æµ‹è¯•åŸºç¡€

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦æµ‹è¯•ï¼Ÿ

**æ ¸å¿ƒä»·å€¼**
- **ä¿éšœè´¨é‡**ï¼šå‘ç° bugã€é˜²æ­¢å›å½’
- **æ–‡æ¡£ä½œç”¨**ï¼šæµ‹è¯•ç”¨ä¾‹å³ä½¿ç”¨æ–‡æ¡£
- **é‡æ„ä¿¡å¿ƒ**ï¼šä¿®æ”¹ä»£ç æ—¶å¿«é€Ÿå‘ç°é—®é¢˜
- **è®¾è®¡æŒ‡å¯¼**ï¼šTDD é©±åŠ¨æ›´å¥½çš„ä»£ç è®¾è®¡

### 1.2 æµ‹è¯•ç±»å‹

```
å•å…ƒæµ‹è¯•ï¼ˆUnit Testingï¼‰
  â†“ éš”ç¦»æµ‹è¯•å•ä¸ªå‡½æ•°/ç»„ä»¶
é›†æˆæµ‹è¯•ï¼ˆIntegration Testingï¼‰
  â†“ æµ‹è¯•å¤šä¸ªæ¨¡å—åä½œ
E2E æµ‹è¯•ï¼ˆEnd-to-End Testingï¼‰
  â†“ æ¨¡æ‹Ÿç”¨æˆ·å®Œæ•´æµç¨‹
```

### 1.3 æµ‹è¯•é‡‘å­—å¡”

```
         /\
        /E2E\        å°‘é‡ã€æ…¢ã€æ˜‚è´µ
       /------\
      /é›†æˆæµ‹è¯• \     ä¸­ç­‰
     /----------\
    /  å•å…ƒæµ‹è¯•   \   å¤§é‡ã€å¿«ã€ä¾¿å®œ
   /--------------\
```

---

## äºŒã€Jestï¼ˆæ¨èï¼‰

### 2.1 åŸºç¡€é…ç½®

```bash
# å®‰è£…
npm install -D jest @types/jest ts-jest

# TypeScript
npm install -D ts-jest @types/jest

# React ç›¸å…³
npm install -D @testing-library/react @testing-library/jest-dom

# åˆå§‹åŒ–
npx ts-jest config:init
```

```javascript
// jest.config.js
module.exports = {
  // æµ‹è¯•ç¯å¢ƒ
  testEnvironment: 'jsdom',  // æˆ– 'node'

  // è½¬æ¢å™¨
  transform: {
    '^.+\\.tsx?$': 'ts-jest'
  },

  // æ¨¡å—è·¯å¾„
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1',
    '\\.(css|less|scss|sass)$': 'identity-proxy'
  },

  // è¦†ç›–ç‡æ”¶é›†
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.{js,jsx,ts,tsx}',
    '!src/**/__tests__/**'
  ],

  // è¦†ç›–ç‡é˜ˆå€¼
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  },

  // æµ‹è¯•æ–‡ä»¶åŒ¹é…
  testMatch: [
    '**/__tests__/**/*.[jt]s?(x)',
    '**/?(*.)+(spec|test).[jt]s?(x)'
  ],

  // è®¾ç½®
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js']
};
```

### 2.2 åŸºç¡€è¯­æ³•

```javascript
// describe: æµ‹è¯•å¥—ä»¶
describe('Math Utils', () => {
  // beforeAll: æ‰€æœ‰æµ‹è¯•å‰æ‰§è¡Œä¸€æ¬¡
  beforeAll(() => {
    console.log('å¼€å§‹æµ‹è¯•');
  });

  // afterAll: æ‰€æœ‰æµ‹è¯•åæ‰§è¡Œä¸€æ¬¡
  afterAll(() => {
    console.log('æµ‹è¯•ç»“æŸ');
  });

  // beforeEach: æ¯ä¸ªæµ‹è¯•å‰æ‰§è¡Œ
  beforeEach(() => {
    // åˆå§‹åŒ–
  });

  // afterEach: æ¯ä¸ªæµ‹è¯•åæ‰§è¡Œ
  afterEach(() => {
    // æ¸…ç†
  });

  // test/it: æµ‹è¯•ç”¨ä¾‹
  test('adds 1 + 2 to equal 3', () => {
    expect(add(1, 2)).toBe(3);
  });

  it('subtracts 5 - 3 to equal 2', () => {
    expect(subtract(5, 3)).toBe(2);
  });
});
```

### 2.3 åŒ¹é…å™¨ï¼ˆMatchersï¼‰

```javascript
// ç›¸ç­‰æ€§
expect(1 + 1).toBe(2);                    // ä¸¥æ ¼ç›¸ç­‰ï¼ˆ===ï¼‰
expect({ name: 'Alice' }).toEqual({ name: 'Alice' });  // æ·±åº¦ç›¸ç­‰
expect([1, 2, 3]).toEqual([1, 2, 3]);

// çœŸå‡å€¼
expect(null).toBeNull();
expect(undefined).toBeUndefined();
expect(true).toBeTruthy();
expect(false).toBeFalsy();

// æ•°å­—
expect(10).toBeGreaterThan(5);
expect(10).toBeLessThan(20);
expect(10).toBeCloseTo(10.001);

// å­—ç¬¦ä¸²
expect('hello').toMatch(/ell/);
expect('hello').toContain('ell');

// æ•°ç»„
expect([1, 2, 3]).toContain(2);
expect([{ name: 'Alice' }]).toContainEqual({ name: 'Alice' });

// å¯¹è±¡
expect(obj).toHaveProperty('name');
expect(obj).toMatchObject({ name: 'Alice' });

// å¼‚å¸¸
expect(() => {
  throw new Error('error');
}).toThrow('error');

// å¼‚æ­¥
await expect(promise).resolves.toBe('value');
await expect(promise).rejects.toThrow('error');
```

### 2.4 å¼‚æ­¥æµ‹è¯•

```javascript
// Promise
test('async test', async () => {
  const data = await fetchData();
  expect(data).toBe('value');
});

// å›è°ƒ
test('callback test', (done) => {
  fetchDataCallback((data) => {
    expect(data).toBe('value');
    done();  // å¿…é¡»è°ƒç”¨ done
  });
});

// è¶…æ—¶
test('async test with timeout', async () => {
  const data = await fetchData();
  expect(data).toBe('value');
}, 5000);  // 5 ç§’è¶…æ—¶
```

### 2.5 Mockï¼ˆæ¨¡æ‹Ÿï¼‰

```javascript
// Mock å‡½æ•°
const mockFn = jest.fn();
mockFn('arg1', 'arg2');

expect(mockFn).toHaveBeenCalled();
expect(mockFn).toHaveBeenCalledTimes(1);
expect(mockFn).toHaveBeenCalledWith('arg1', 'arg2');
expect(mockFn).toHaveLastReturnedWith('result');

// è¿”å›å€¼
jest.fn().mockReturnValue('value');
jest.fn().mockResolvedValue('value');
jest.fn().mockRejectedValue('error');

// Mock æ¨¡å—
jest.mock('./api');
import { fetchData } from './api';

fetchData.mockResolvedValue({ data: 'mock' });

// Mock éƒ¨åˆ†
jest.spyOn(api, 'fetchData').mockResolvedValue({ data: 'mock' });

// æ¸…é™¤ Mock
afterEach(() => {
  jest.clearAllMocks();
});

// å®šæ—¶å™¨ Mock
jest.useFakeTimers();
jest.advanceTimersByTime(1000);
jest.runAllTimers();
jest.useRealTimers();
```

---

## ä¸‰ã€Vitestï¼ˆæ¨èï¼ŒVite é¡¹ç›®ï¼‰

### 3.1 é…ç½®

```bash
# å®‰è£…
npm install -D vitest @vitest/ui

# TypeScript æ”¯æŒï¼ˆVite å·²å†…ç½®ï¼‰
```

```javascript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,           // å…¨å±€ APIï¼ˆdescribe, test, expectï¼‰
    environment: 'jsdom',    // æˆ– 'node'
    setupFiles: './jest.setup.ts',
    coverage: {
      provider: 'v8',        // æˆ– 'istanbul'
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/**/*.d.ts'
      ]
    }
  }
});
```

### 3.2 ä½¿ç”¨æ–¹å¼

```javascript
// å’Œ Jest å‡ ä¹ç›¸åŒçš„ API
import { describe, it, expect, vi } from 'vitest';

describe('Math Utils', () => {
  it('adds 1 + 2 to equal 3', () => {
    expect(add(1, 2)).toBe(3);
  });

  it('mocks a function', () => {
    const fn = vi.fn();
    fn();
    expect(fn).toHaveBeenCalled();
  });
});
```

```bash
# è¿è¡Œæµ‹è¯•
npx vitest

# UI æ¨¡å¼
npx vitest --ui

# è¦†ç›–ç‡
npx vitest --coverage
```

---

## å››ã€Testing Libraryï¼ˆReact ç»„ä»¶æµ‹è¯•ï¼‰

### 4.1 åŸºç¡€ç”¨æ³•

```bash
# å®‰è£…
npm install -D @testing-library/react @testing-library/jest-dom @testing-library/user-event
```

```javascript
// Button.test.tsx
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import Button from './Button';

describe('Button Component', () => {
  it('renders button with text', () => {
    render(<Button>Click me</Button>);

    // æŸ¥è¯¢å…ƒç´ 
    const button = screen.getByText('Click me');
    expect(button).toBeInTheDocument();
  });

  it('calls onClick when clicked', async () => {
    const user = userEvent.setup();
    const handleClick = vi.fn();

    render(<Button onClick={handleClick}>Click me</Button>);

    const button = screen.getByRole('button', { name: /click me/i });
    await user.click(button);

    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('is disabled when disabled prop is true', () => {
    render(<Button disabled>Click me</Button>);

    const button = screen.getByRole('button');
    expect(button).toBeDisabled();
  });
});
```

### 4.2 æŸ¥è¯¢æ–¹æ³•

```javascript
// ä¼˜å…ˆçº§é¡ºåº

// 1. getByRoleï¼ˆæœ€æ¨èï¼‰
screen.getByRole('button', { name: /submit/i });
screen.getByRole('textbox', { name: /email/i });

// 2. getByLabelText
screen.getByLabelText(/email/i);

// 3. getByPlaceholderText
screen.getByPlaceholderText(/enter your email/i);

// 4. getByText
screen.getByText(/submit/i);

// 5. getByTestIdï¼ˆæœ€åé€‰æ‹©ï¼‰
screen.getByTestId('submit-button');

// æŸ¥è¯¢å˜ä½“
getBy...()     // æŠ›å‡ºå¼‚å¸¸ï¼ˆæœªæ‰¾åˆ°ï¼‰
queryBy...()   // è¿”å› nullï¼ˆæœªæ‰¾åˆ°ï¼‰
findBy...()    // å¼‚æ­¥æŸ¥æ‰¾ï¼ˆé»˜è®¤ç­‰å¾… 1000msï¼‰

// æŸ¥è¯¢å¤šä¸ª
getAllBy...()
queryAllBy...()
findAllBy...()
```

### 4.3 å¼‚æ­¥ç»„ä»¶æµ‹è¯•

```javascript
// AsyncComponent.test.tsx
import { render, screen, waitFor } from '@testing-library/react';
import AsyncComponent from './AsyncComponent';

describe('AsyncComponent', () => {
  it('shows loading state', () => {
    render(<AsyncComponent />);
    expect(screen.getByText(/loading/i)).toBeInTheDocument();
  });

  it('displays data after loading', async () => {
    render(<AsyncComponent />);

    // ç­‰å¾…å…ƒç´ å‡ºç°
    await waitFor(() => {
      expect(screen.getByText(/data/i)).toBeInTheDocument();
    });
  });

  it('handles fetch errors', async () => {
    // Mock API
    vi.mock('./api', () => ({
      fetchData: vi.fn().mockRejectedValue(new Error('Failed'))
    }));

    render(<AsyncComponent />);

    await waitFor(() => {
      expect(screen.getByText(/error/i)).toBeInTheDocument();
    });
  });
});
```

---

## äº”ã€æµ‹è¯•æœ€ä½³å®è·µ

### 5.1 æµ‹è¯•åŸåˆ™

```
1. æµ‹è¯•ç”¨æˆ·è¡Œä¸ºï¼Œè€Œéå®ç°ç»†èŠ‚
2. ä¸€ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä»¶äº‹
3. æµ‹è¯•åº”è¯¥ç‹¬ç«‹ä¸”å¯é‡å¤
4. ä½¿ç”¨æœ‰æ„ä¹‰çš„æè¿°
5. ä¿æŒæµ‹è¯•ç®€å•å¯è¯»
```

### 5.2 AAA æ¨¡å¼

```javascript
test('user can login', async () => {
  // Arrangeï¼ˆå‡†å¤‡ï¼‰
  const user = userEvent.setup();
  render(<LoginForm />);

  // Actï¼ˆæ‰§è¡Œï¼‰
  await user.type(screen.getByLabelText(/username/i), 'alice');
  await user.type(screen.getByLabelText(/password/i), 'password');
  await user.click(screen.getByRole('button', { name: /login/i }));

  // Assertï¼ˆæ–­è¨€ï¼‰
  expect(screen.getByText(/welcome, alice/i)).toBeInTheDocument();
});
```

### 5.3 é¿å… Testing åæ¨¡å¼

```javascript
// âŒ æµ‹è¯•å®ç°ç»†èŠ‚
test('uses useState hook', () => {
  render(<Component />);
  // ä¸è¦æµ‹è¯•æ˜¯å¦ä½¿ç”¨äº† useState
});

// âœ… æµ‹è¯•ç”¨æˆ·è¡Œä¸º
test('updates count when button is clicked', async () => {
  render(<Counter />);
  await user.click(screen.getByRole('button'));
  expect(screen.getByText(/count: 1/i)).toBeInTheDocument();
});

// âŒ æµ‹è¯•ç±»å
expect(container.querySelector('.active')).toBeTruthy();

// âœ… æµ‹è¯•å¯è®¿é—®æ€§
expect(screen.getByRole('button')).toHaveClass('active');
```

---

## å…­ã€å¸¸è§é—®é¢˜ä¸é¿å‘æŒ‡å—

### âŒ é—®é¢˜ 1ï¼šæµ‹è¯•ä¸ç¨³å®š

```javascript
// âŒ ç¡¬ç¼–ç å»¶è¿Ÿ
await waitFor(() => {
  expect(element).toBeInTheDocument();
}, { timeout: 5000 });

// âœ… ä½¿ç”¨ waitFor å’Œåˆç†çš„è¶…æ—¶
await waitFor(() => {
  expect(element).toBeInTheDocument();
}, { timeout: 3000 });
```

### âŒ é—®é¢˜ 2ï¼šMock è¿‡åº¦

```javascript
// âŒ è¿‡åº¦ Mock
jest.mock('react', () => ({
  useState: jest.fn(),
  useEffect: jest.fn()
}));

// âœ… ä»… Mock å¤–éƒ¨ä¾èµ–
jest.mock('./api', () => ({
  fetchData: jest.fn().mockResolvedValue({ data: 'mock' })
}));
```

### âŒ é—®é¢˜ 3ï¼šæµ‹è¯•ç§æœ‰æ–¹æ³•

```javascript
// âŒ æµ‹è¯•ç§æœ‰æ–¹æ³•
expect(component.privateMethod()).toBe('value');

// âœ… æµ‹è¯•å…¬å…± API
expect(component.publicMethod()).toBe('result');
```

---

## ä¸ƒã€æ€»ç»“ä¸è®°å¿†è¦ç‚¹

### ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€

```
æµ‹è¯•é‡‘å­—å¡”è®°å¿ƒä¸Š
å•å…ƒæµ‹è¯•æœ€å¤šå†™
é›†æˆæµ‹è¯•é€‚ä¸­é‡
E2E æµ‹è¯•å°‘é‡åš
Jest Vitest é€‰ä¸€ä¸ª
Testing Library æµ‹è¯•ç»„ä»¶
AAA æ¨¡å¼å†™æµ‹è¯•
æµ‹è¯•ç”¨æˆ·è¡Œä¸º
ä¸æµ‹å®ç°ç»†èŠ‚
ä¿æŒæµ‹è¯•ç®€å•å¯è¯»
```

### ğŸ“š å…³é”®æŠ€æœ¯ç‚¹

1. **Jest/Vitest**ï¼šæµ‹è¯•æ¡†æ¶ã€åŒ¹é…å™¨ã€Mock
2. **Testing Library**ï¼šç»„ä»¶æµ‹è¯•ã€æŸ¥è¯¢æ–¹æ³•
3. **å¼‚æ­¥æµ‹è¯•**ï¼šPromiseã€async/awaitã€waitFor
4. **æœ€ä½³å®è·µ**ï¼šAAA æ¨¡å¼ã€æµ‹è¯•ç”¨æˆ·è¡Œä¸ºã€é¿å…è¿‡åº¦ Mock
5. **è¦†ç›–ç‡**ï¼šè¯­å¥ã€åˆ†æ”¯ã€å‡½æ•°ã€è¡Œè¦†ç›–ç‡

---

## å…«ã€å®æˆ˜ç»ƒä¹ å»ºè®®

1. ä¸ºç°æœ‰å‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•
2. æµ‹è¯• React ç»„ä»¶çš„äº¤äº’
3. Mock API è°ƒç”¨æµ‹è¯•å¼‚æ­¥é€»è¾‘
4. å®ç°æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
5. é›†æˆæµ‹è¯•åˆ° CI/CD æµç¨‹

---

**ä¸‹ä¸€æ­¥å­¦ä¹ **ï¼šğŸ‘‰ [é›†æˆæµ‹è¯•](./é›†æˆæµ‹è¯•.md)
